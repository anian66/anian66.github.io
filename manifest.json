// ğŸ“± mPhone ä¸»ç³»ç»Ÿ v3.1 (å¼ºåŒ–è§¦æ‘¸å…¼å®¹ç‰ˆ)
window.addEventListener("load", () => {
  console.log("ğŸ“± mPhone ç³»ç»Ÿå¯åŠ¨ä¸­...");

  // ========== ğŸ•’ åŠ¨æ€æ—¶é’Ÿ ==========
  function updateTime() {
    const now = new Date();
    let h = now.getHours();
    let m = now.getMinutes();
    if (m < 10) m = "0" + m;
    const statusTime = document.getElementById("statusTime");
    const lockTime = document.getElementById("lockTime");
    const lockDate = document.getElementById("lockDate");
    if (statusTime) statusTime.textContent = `${h}:${m}`;
    if (lockTime) lockTime.textContent = `${h}:${m}`;
    if (lockDate) {
      const week = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"];
      lockDate.textContent = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${week[now.getDay()]}`;
    }
  }
  setInterval(updateTime, 1000);
  updateTime();


  // ========== ğŸ”“ ä¸Šæ»‘è§£é” ==========
  const lockScreen = document.getElementById("lockScreen");
  const homeScreen = document.getElementById("homeScreen");
  const unlockArea = document.getElementById("unlockArea");
  let startY = null;
  let isDragging = false;

  function startDrag(y) {
    startY = y;
    isDragging = true;
  }

  function moveDrag(y) {
    if (!isDragging || !lockScreen) return;
    const dy = startY - y;
    if (dy > 0) {
      eCancelScroll();
      lockScreen.style.transition = "none";
      lockScreen.style.transform = `translateY(${-dy * 0.4}px)`;
    }
  }

  function endDrag(y) {
    if (!isDragging || !lockScreen) return;
    const dy = startY - y;
    isDragging = false;
    if (dy > 80) unlockPhone();
    else {
      lockScreen.style.transition = "all 0.25s ease";
      lockScreen.style.transform = "translateY(0)";
      lockScreen.style.opacity = "1";
    }
  }

  // ç¦æ­¢é¡µé¢æ»šåŠ¨
  function eCancelScroll() {
    document.body.style.overflow = "hidden";
  }

  function unlockPhone() {
    lockScreen.style.transition = "all 0.4s ease";
    lockScreen.style.transform = "translateY(-100%)";
    lockScreen.style.opacity = "0";
    homeScreen.style.display = "flex";
    resetLockTimer();
    document.body.style.overflow = "hidden";
  }

 const dragTarget = document.getElementById("lockScreen");

if (dragTarget) {
  dragTarget.addEventListener("touchstart", e => {
    startDrag(e.touches[0].clientY);
    e.preventDefault();
  }, { passive: false });

  dragTarget.addEventListener("touchmove", e => {
    moveDrag(e.touches[0].clientY);
    e.preventDefault();
  }, { passive: false });

  dragTarget.addEventListener("touchend", e => {
    endDrag(e.changedTouches[0].clientY);
    e.preventDefault();
  }, { passive: false });

  // æ¡Œé¢é¼ æ ‡å…¼å®¹
  dragTarget.addEventListener("mousedown", e => startDrag(e.clientY));
  window.addEventListener("mousemove", e => moveDrag(e.clientY));
  window.addEventListener("mouseup", e => endDrag(e.clientY));
}



  // ========== ğŸ“± é¡¶éƒ¨ä¸‹æ‹‰é¢æ¿ ==========
  const notifCenter = document.getElementById("notifCenter");
  const widgetCenter = document.getElementById("widgetCenter");
  let pulling = null, pullStartY = 0;
  const PULL_ZONE_HEIGHT = 60;

  function pullStart(e) {
    const y = e.touches ? e.touches[0].clientY : e.clientY;
    const x = e.touches ? e.touches[0].clientX : e.clientX;
    if (y > PULL_ZONE_HEIGHT) return;
    pulling = (x < window.innerWidth / 2) ? "notif" : "widget";
    pullStartY = y;
  }

  function pullMove(e) {
    if (!pulling) return;
    const y = e.touches ? e.touches[0].clientY : e.clientY;
    const dy = y - pullStartY;
    if (dy < 0) return;
    const panel = (pulling === "notif") ? notifCenter : widgetCenter;
    if (panel) {
      const maxHeight = window.innerHeight * 0.7;
      const progress = Math.min(dy / maxHeight, 1);
      panel.style.transition = "none";
      panel.style.transform = `translateY(${(-100 + progress * 100)}%)`;
    }
  }

  function pullEnd(e) {
    if (!pulling) return;
    const y = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
    const dy = y - pullStartY;
    const panel = (pulling === "notif") ? notifCenter : widgetCenter;
    if (panel) {
      if (dy > 100) {
        panel.style.transition = "transform 0.3s ease";
        panel.style.transform = "translateY(0%)";
        panel.dataset.open = "true";
      } else {
        panel.style.transition = "transform 0.3s ease";
        panel.style.transform = "translateY(-100%)";
        panel.dataset.open = "false";
      }
    }
    pulling = null;
  }

  document.addEventListener("mousedown", pullStart);
  document.addEventListener("mousemove", pullMove);
  document.addEventListener("mouseup", pullEnd);
  document.addEventListener("touchstart", pullStart, { passive: true });
  document.addEventListener("touchmove", pullMove, { passive: true });
  document.addEventListener("touchend", pullEnd, { passive: true });

  // ç‚¹å‡»å…³é—­å·²æ‰“å¼€çš„é¢æ¿
  document.addEventListener("click", () => {
    [notifCenter, widgetCenter].forEach(panel => {
      if (panel && panel.dataset.open === "true") {
        panel.style.transform = "translateY(-100%)";
        panel.dataset.open = "false";
      }
    });
  });


  // ========== âš™ï¸ æ™ºèƒ½ç¼©æ”¾ ==========
  function autoScalePhone() {
    const phone = document.querySelector(".phone-frame");
    if (!phone) return;
    const baseWidth = 400, baseHeight = 880;
    const winW = window.innerWidth, winH = window.innerHeight;
    const scale = Math.min(winW / (baseWidth + 60), winH / (baseHeight + 60));
    phone.style.transform = `scale(${scale})`;
    phone.style.transformOrigin = "center center";
  }
  autoScalePhone();
  window.addEventListener("resize", autoScalePhone);


  // ========== â° è‡ªåŠ¨é”å± ==========
  let lockTimeout = null;
  function resetLockTimer() {
    clearTimeout(lockTimeout);
    lockTimeout = setTimeout(() => {
      homeScreen.style.display = "none";
      lockScreen.style.transition = "all 0.4s ease";
      lockScreen.style.transform = "translateY(0)";
      lockScreen.style.opacity = "1";
    }, 30000);
  }
  ["click","mousemove","touchstart"].forEach(e =>
    document.addEventListener(e, resetLockTimer)
  );
  resetLockTimer();


  // ========== ğŸµ éŸ³ä¹ç³»ç»Ÿ ==========
  const musicBar = document.getElementById("musicProgressBar");
  const musicBtn = document.getElementById("musicToggle");
  const musicTitle = document.getElementById("musicTitle");
  const musicArtist = document.getElementById("musicArtist");
  let isPlaying = true, progress = 0;

  const MusicApp = {
    current: { title: "å¤æ—¥æ™´ç©º", artist: "å°A" },
    play() { isPlaying = true; if (musicBtn) musicBtn.textContent = "â¸"; },
    pause() { isPlaying = false; if (musicBtn) musicBtn.textContent = "â–¶"; },
    toggle() { isPlaying ? this.pause() : this.play(); },
    updateProgress() {
      if (isPlaying && musicBar) {
        progress = (progress + 1) % 100;
        musicBar.style.width = `${progress}%`;
      }
    }
  };
  if (musicBtn) {
    musicBtn.addEventListener("click", ()=>MusicApp.toggle());
    setInterval(()=>MusicApp.updateProgress(),500);
  }

  const appMusic = document.getElementById("appMusic");
  if (appMusic) {
    appMusic.addEventListener("click", ()=>{
      createBubbleMessage("ğŸµ æ‰“å¼€éŸ³ä¹æ’­æ”¾å™¨");
      MusicApp.play();
    });
  }

  // ========== ğŸ”” æ°”æ³¡é€šçŸ¥ ==========
  function createBubbleMessage(text="æ‚¨æœ‰ä¸€æ¡æ–°æ¶ˆæ¯") {
    const bubble = document.createElement("div");
    bubble.textContent = text;
    Object.assign(bubble.style, {
      position: "absolute",
      bottom: "100px",
      left: "50%",
      transform: "translateX(-50%)",
      padding: "8px 16px",
      borderRadius: "20px",
      background: "rgba(255,255,255,0.15)",
      backdropFilter: "blur(10px)",
      boxShadow: "0 4px 10px rgba(0,0,0,0.4)",
      transition: "opacity 0.5s ease",
      opacity: "0",
      zIndex: "10000"
    });
    document.querySelector(".phone-frame").appendChild(bubble);
    setTimeout(()=>bubble.style.opacity="1",100);
    setTimeout(()=>{
      bubble.style.opacity="0";
      setTimeout(()=>bubble.remove(),600);
    },4000);
  }

  // ========== âœ… è‡ªæ£€ ==========
  console.log("âœ… main.js å·²åŠ è½½");
  if (window.ThemeEngine) console.log("âœ… ThemeEngine å·²è¿æ¥");
  else console.warn("âš ï¸ æœªæ£€æµ‹åˆ° ThemeEngine");
});
